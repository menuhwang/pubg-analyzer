<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header('Admin 페이지')}"></head>
<body>
<nav th:replace="~{fragments/admin/navbar :: navbar}"></nav>
<div class="container-fluid p-5 position-relative">
    <div class="row g-4">
        <!--sidebar:left-->
        <aside class="col-md-3 col-xl-2">
            <div th:replace="~{fragments/admin/sidebar :: sidebar}"></div>
        </aside>
        <div class="col-auto vstack gap-4">
            <h1>PUBG API 호출</h1>
            <div>
                <ul class="nav nav-tabs" id="fetchTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="player-tab" data-bs-toggle="tab" data-bs-target="#player-tab-pane" type="button" role="tab" aria-controls="player-tab-pane" aria-selected="true">Player</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="match-tab" data-bs-toggle="tab" data-bs-target="#match-tab-pane" type="button" role="tab" aria-controls="match-tab-pane" aria-selected="false">Match</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="telemetry-tab" data-bs-toggle="tab" data-bs-target="#telemetry-tab-pane" type="button" role="tab" aria-controls="telemetry-tab-pane" aria-selected="false" disabled>Telemetry</button>
                    </li>
                </ul>
                <div class="tab-content border border-top-0 rounded-bottom p-3" id="fetchTabContent">
                    <!-- player 조회 pane -->
                    <div class="tab-pane fade show active" id="player-tab-pane" role="tabpanel" aria-labelledby="player-tab" tabindex="0">
                        <h2>Request</h2>
                        <div class="row mb-3">
                            <label class="col-2 col-form-label" for="shard-select">플랫폼</label>
                            <div class="col-2">
                                <select class="form-select" id="shard-select">
                                    <option>Steam</option>
                                    <option>Kakao</option>
                                </select>
                            </div>
                            <label class="col-2 col-form-label" for="nickname-input">닉네임</label>
                            <div class="col">
                                <input class="form-control" type="text" id="nickname-input">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-primary">Execute</button>
                            </div>
                        </div>
                        <h3>Response</h3>
                        <textarea class="form-control" rows="30" readonly></textarea>
                    </div>
                    <div class="tab-pane fade" id="match-tab-pane" role="tabpanel" aria-labelledby="match-tab" tabindex="0">
                        <h2>Request</h2>
                        <div class="row mb-3">
                            <label class="col-2 col-form-label" for="match-input">매치 ID</label>
                            <div class="col">
                                <input class="form-control" type="text" id="match-input">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-primary">Execute</button>
                            </div>
                        </div>
                        <h3>Response</h3>
                        <textarea class="form-control" rows="30" readonly></textarea>
                    </div>
                    <div class="tab-pane fade" id="telemetry-tab-pane" role="tabpanel" aria-labelledby="telemetry-tab" tabindex="0">telemetry</div>
                </div>
            </div>
        </div>
    </div>
    <th:block th:replace="~{fragments/footer :: footer}"></th:block>
</div>
<script>
    // Bootstrap Init
    const toastOption = {
        animation: true,
        autohide: true,
        delay: 5000
    }
    const toastElList = document.querySelectorAll('.toast')
    const toastList = [...toastElList].map(toastEl => new bootstrap.Toast(toastEl, toastOption))
</script>
<script>
    const wholeCheckInputChangeHandler = (e) => {
        matchCheckInputs.forEach(ele => {
            ele.checked = e.target.checked;
        })
    }

    const deleteFailedCallback = (response) => {
        if (!response.ok) {
            deleteFailedAlert.show();
        } else {
            location.reload();
        }
    }

    const fetchDeleteSelected = () => {
        const matches = [];
        matchCheckInputs.forEach(ele => {
            if (ele.checked) matches.push(ele.value);
        });
        fetch('/api/admin/matches', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({matches})
        }).then(response => {
            if (!response.ok) {
                deleteFailedAlert.show();
            } else {
                location.reload();
            }
        })
    }

    const fetchDeleteConditional = () => {
        const condition = document.getElementById('condition').value;
        const createdAt = document.getElementById('createdAt').value;
        if (createdAt === '') {
            alert('날짜를 선택해주세요.');
            return;
        }
        fetch(`/api/admin/matches/${condition}/${createdAt}`, {
            method: 'DELETE'
        }).then(deleteFailedCallback);
    }

    const wholeCheckInput = document.querySelector('.whole-check-input');
    const matchCheckInputs = document.querySelectorAll('.single-check-input');
    const deleteFailedAlert = bootstrap.Toast.getInstance(document.querySelector('.delete-failed-alert'));
    const deleteSelectedBtn = document.querySelector('.delete-selected-btn');
    const deleteConditionalBtn = document.querySelector('.delete-conditional-btn');

    wholeCheckInput.addEventListener('change', wholeCheckInputChangeHandler);
    deleteSelectedBtn.addEventListener('click', fetchDeleteSelected);
    deleteConditionalBtn.addEventListener('click', fetchDeleteConditional);
</script>
</body>
</html>